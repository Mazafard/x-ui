<!DOCTYPE html>
<html lang="en">
{{template "head" .}}
<style>
    @media (min-width: 769px) {
        .ant-layout-content {
            margin: 24px 16px;
        }
    }

    .ant-col-sm-24 {
        margin-top: 10px;
    }
</style>
<body>
<a-layout id="app" v-cloak>
    {{ template "commonSider" . }}
    <a-layout id="content-layout">
        <a-layout-content>
            <a-spin :spinning="spinning" :delay="500" tip="loading">
                <transition name="list" appear>
                    <a-tag v-if="false" color="red" style="margin-bottom: 10px">
                        Please go to the panel settings as soon as possible to modify the username and password, otherwise there may be a risk of leaking account information
                    </a-tag>
                </transition>
                <transition name="list" appear>
                    <a-card hoverable style="margin-bottom: 20px;">
                        <a-row>
                            <a-col :xs="24" :sm="24" :lg="12">
                                {{ i18n "pages.clients.totalDownUp" }}：
                                <a-tag color="green">[[ sizeFormat(total.up) ]] / [[ sizeFormat(total.down) ]]</a-tag>
                            </a-col>
                            <a-col :xs="24" :sm="24" :lg="12">
                                {{ i18n "pages.clients.totalUsage" }}：
                                <a-tag color="green">[[ sizeFormat(total.up + total.down) ]]</a-tag>
                            </a-col>
                            <a-col :xs="24" :sm="24" :lg="12">
                                {{ i18n "pages.clients.clientCount" }}：
                                <a-tag color="green">[[ dbClients.length ]]</a-tag>
                            </a-col>
                        </a-row>
                    </a-card>
                </transition>
                <transition name="list" appear>
                    <a-card hoverable>
                        <div slot="title">
                            <a-button type="primary" icon="plus" @click="openAddClient"></a-button>
                        </div>

<!--                        <a-input v-model="searchKey" placeholder="search" autofocus style="max-width: 300px"></a-input>-->
                        <a-table :columns="columns" :row-key="dbClient => dbClient.id"
                                 :data-source="dbClients"
                                 :loading="spinning" :scroll="{ x: 1500 }"
                                 :pagination="true"
                                 style="margin-top: 20px"
                                 @change="() => getDBClients()">
                            <template slot="action" slot-scope="text, dbClient">
                                <a-dropdown :trigger="['click']">
                                    <a @click="e => e.preventDefault()">{{ i18n "pages.clients.operate" }}</a>
                                    <a-menu slot="overlay" @click="a => clickAction(a, dbClient)">
                                        <a-menu-item v-if="dbClient.hasLink()" key="qrcode">
                                            <a-icon type="qrcode"></a-icon>
                                            {{ i18n "qrCode" }}
                                        </a-menu-item>
                                        <a-menu-item key="edit">
                                            <a-icon type="edit"></a-icon>
                                            {{ i18n "edit" }}
                                        </a-menu-item>
                                        <a-menu-item key="resetTraffic">
                                            <a-icon type="retweet"></a-icon> {{ i18n "pages.clients.resetTraffic" }}
                                        </a-menu-item>
                                        <a-menu-item key="delete">
                                            <span style="color: #FF4D4F">
                                                <a-icon type="delete"></a-icon> {{ i18n "delete"}}
                                            </span>
                                        </a-menu-item>
                                    </a-menu>
                                </a-dropdown>
                            </template>

                            <template slot="enable" slot-scope="text, dbClient">
                                <a-switch v-model="dbClient.enable" @change="switchEnable(dbClient)"></a-switch>
                            </template>

                            <template slot="expiryTime" slot-scope="text, dbClient">
                                <template v-if="dbClient.expiryTime > 0">
                                    <a-tag v-if="dbClient.isExpiry" color="red">
                                        [[ DateUtil.formatMillis(dbClient.expiryTime) ]]
                                    </a-tag>
                                    <a-tag v-else color="blue">
                                        [[ DateUtil.formatMillis(dbClient.expiryTime) ]]
                                    </a-tag>
                                </template>
                                <a-tag v-else color="green">{{ i18n "indefinitely" }}</a-tag>
                            </template>
                        </a-table>
                    </a-card>
                </transition>
            </a-spin>
        </a-layout-content>
    </a-layout>
</a-layout>
{{template "js" .}}
<script>

    const columns = [ {
        title: '{{ i18n "pages.clients.enable" }}',
        align: 'center',
        width: 40,
        scopedSlots: { customRender: 'enable' },
    }, {
        title: "Id",
        align: 'center',
        dataIndex: "id",
        width: 70,
    }, {
        title: '{{ i18n "pages.clients.email" }}',
        align: 'center',
        width: 100,
        dataIndex: "email",
    }, {
        title: '{{ i18n "pages.clients.limitIP" }}',
        align: 'center',
        width: 60,
        dataIndex: "limitIp",
    }, {
        title: '{{ i18n "pages.clients.security" }}',
        align: 'center',
        dataIndex: "security",
        width: 60,
    }, {
        title: '{{ i18n "pages.clients.traffic" }}↑|↓',
        align: 'center',
        width: 150,
        dataIndex: 'totalGB',
        // scopedSlots: { customRender: 'total_gb' },
    }, {
        title: '{{ i18n "pages.clients.expireDate" }}',
        align: 'center',
        width: 80,
        scopedSlots: { customRender: 'expiryTime' },
    }];

    const app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        data: {
            siderDrawer,
            spinning: false,
            clients: [],
            dbClients: [],
            searchKey: '',
        },
        methods: {
            loading(spinning=true) {
                this.spinning = spinning;
            },
            async getDBClients() {
                this.loading();
                const msg = await HttpUtil.get('/xui/client/');
                this.loading(false);
                if (!msg.success) {
                    return;
                }
                this.setClients(msg.obj);
            },
            setClients(dbClients) {
                this.clients.splice(0);
                this.dbClients.splice(0);
                console.log("+++++++++++++++++")
                console.log(dbClients)
                for (const client of dbClients) {
                    const dbClient = new DBClient(client);
                    this.clients.push(dbClient.toClient());
                    this.dbClients.push(dbClient);
                    console.log(this.clients)
                }
            },
            searchClients(key) {
                if (ObjectUtil.isEmpty(key)) {
                    this.searchedClients = this.dbClients.slice();
                } else {
                    this.searchedClients.splice(0, this.searchedClients.length);
                    this.dbClients.forEach(client => {
                        if (ObjectUtil.deepSearch(client, key)) {
                            this.searchedClients.push(client);
                        }
                    });
                }
            },
            clickAction(action, dbClient) {
                switch (action.key) {
                    case "qrcode":
                        this.showQrcode(dbClient);
                        break;
                    case "edit":
                        this.openEditClient(dbClient);
                        break;
                    case "resetTraffic":
                        this.resetTraffic(dbClient);
                        break;
                    case "delete":
                        this.delClient(dbClient);
                        break;
                }
            },
            openAddClient() {
                clModal.show({
                    title: '{{ i18n "pages.clients.addClient"}}',
                    okText: '{{ i18n "pages.clients.addTo"}}',
                    cancelText: '{{ i18n "close" }}',
                    confirm: async (client, dbClient) => {
                        clModal.loading();
                        await this.addClient(client, dbClient);
                        clModal.close();
                    },
                    isEdit: false
                });
            },
            openEditClient(dbClient) {
                const client = dbClient.toClient();
                clModal.show({
                    title: '{{ i18n "pages.clients.modifyClient"}}',
                    okText: '{{ i18n "pages.clients.revise"}}',
                    cancelText: '{{ i18n "close" }}',
                    client: client,
                    dbClient: dbClient,
                    confirm: async (client, dbClient) => {
                        clModal.loading();
                        await this.updateClient(client, dbClient);
                        clModal.close();
                    },
                    isEdit: true
                });
            },
            async addClient(client, dbClient) {
                const data = {
                    up: dbClient.up,
                    down: dbClient.down,
                    total: dbClient.total,
                    remark: dbClient.remark,
                    enable: dbClient.enable,
                    expiryTime: dbClient.expiryTime,

                    listen: client.listen,
                    port: client.port,
                    protocol: client.protocol,
                    settings: client.settings.toString(),
                    streamSettings: client.stream.toString(),
                    sniffing: client.canSniffing() ? client.sniffing.toString() : '{}',
                };
                await this.submit('/xui/client/', data, clModal);
            },
            async updateClient(client, dbClient) {
                const data = {
                    up: dbClient.up,
                    down: dbClient.down,
                    total: dbClient.total,
                    remark: dbClient.remark,
                    enable: dbClient.enable,
                    expiryTime: dbClient.expiryTime,

                    listen: client.listen,
                    port: client.port,
                    protocol: client.protocol,
                    settings: client.settings.toString(),
                    streamSettings: client.stream.toString(),
                    sniffing: client.canSniffing() ? client.sniffing.toString() : '{}',
                };
                await this.submitPut(`/xui/client/${dbClient.id}`, data, clModal);
            },
            resetTraffic(dbClient) {
                this.$confirm({
                    title: '{{ i18n "pages.clients.resetTraffic"}}',
                    content: '{{ i18n "pages.clients.resetTrafficContent"}}',
                    okText: '{{ i18n "reset"}}',
                    cancelText: '{{ i18n "cancel"}}',
                    onOk: () => {
                        const client = dbClient.toClient();
                        dbClient.up = 0;
                        dbClient.down = 0;
                        this.updateClient(client, dbClient);
                    },
                });
            },
            delClient(dbClient) {
                this.$confirm({
                    title: '{{ i18n "pages.clients.deleteClient"}}',
                    content: '{{ i18n "pages.clients.deleteClientContent"}}',
                    okText: '{{ i18n "delete"}}',
                    cancelText: '{{ i18n "cancel"}}',
                    onOk: () => this.submit('/xui/client/del/' + dbClient.id),
                });
            },

            showInfo(dbClient) {
                infoModal.show(dbClient);
            },
            switchEnable(dbClient) {
                this.submitPatch(`/xui/client/${dbClient.id}`, dbClient);
            },
            async submit(url, data, modal) {
                const msg = await HttpUtil.postWithModal(url, data, modal);
                if (msg.success) {
                    await this.getDBClients();
                }
            },
            async submitPut(url, data, modal) {
                const msg = await HttpUtil.putWithModal(url, data, modal);
                if (msg.success) {
                    await this.getDBClients();
                }
            },
            async submitPatch(url, data, modal) {
                const msg = await HttpUtil.putWithModal(url, data, modal);
                if (msg.success) {
                    await this.getDBClients();
                }
            },
        },
        watch: {
            searchKey(value) {
                this.searchClients(value);
            }
        },
        mounted() {
            this.getDBClients();
        },
        computed: {
            total() {
                let down = 0, up = 0;
                for (let i = 0; i < this.dbClients.length; ++i) {
                    down += this.dbClients[i].down;
                    up += this.dbClients[i].up;
                }
                return {
                    down: down,
                    up: up,
                };
            }
        },
    });

</script>
{{template "clientModal"}}
<!--{{template "promptModal"}}-->
<!--{{template "qrcodeModal"}}-->
{{template "textModal"}}
<!--{{template "clientInfoModal"}}-->
</body>
</html>